---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by yuyou.
--- DateTime: 2024/3/23 23:55
---
local L = AceLibrary("AceLocale-2.2"):new("MasterLoot")
MasterLootFrame = {}
MasterLootFrame.DropDown = AceLibrary("Dewdrop-2.0")

----- Menu exhibition -----
function MasterLootFrame:SetupFrame()
    local icon, name, quantity, quality = GetLootSlotInfo(LootFrame.selectedSlot)
    if quality < 1 then
        GiveMasterLoot(LootFrame.selectedSlot,  self:GetMLID(UnitName("player")))
        return
    end

    self.DropDown:Open(
            UIParent,
            'children',
            function(level, value)
                self:CreateFrame(level, value)
            end,
            'cursorX', true,
            'cursorY', true
            )
end

function MasterLootFrame:CreateFrame(level, value)
    if level == 1 then
        self:CreateItem()
        self:CreateSelfDropDown()
        self:CreateRandomRollDropDown()
        local classList = self:ScranCandidateList()
        self:CreateClassListDropDown(classList)
    elseif level == 2 then
        self:CreateClassListPlayerDropDown(value)
    end
end


function LinkToID(link)
    if not link then return nil end
    return string.gsub(link,".-\124H([^\124]*)\124h.*", "%1")
end
function MasterLootFrame:CreateItem()
    local icon, name, quantity, quality = GetLootSlotInfo(LootFrame.selectedSlot)
    local link = LinkToID(GetLootSlotLink(LootFrame.selectedSlot))
    if not link then return nil end
    self.DropDown:AddLine(
            'text', string.format("%s%s%s|r", tonumber(quantity) > 1 and tostring(quantity).."x" or "", ITEM_QUALITY_COLORS[quality].hex, name),
            'icon', icon,
            'iconWidth', 20,
            'iconHeight', 20,
            'tooltipFunc', GameTooltip.SetHyperlink,
            'tooltipArg1', GameTooltip ,
            'tooltipArg2', link )
    self.selectedSlotItemLink = link

end





function MasterLootFrame:ScranCandidateList()
    local classList = {}
    local NumMembers = GetNumRaidMembers()
    if NumMembers then
        self.prefix = "raid"
        NumMembers = 40
    else
        NumMembers = GetNumPartyMembers()
        self.prefix = "party"
    end

    for i = 1, NumMembers do
        local classNameColored, targetNameColored = self:GetClassNameWithColors(self.prefix..i)
        if classNameColored and targetNameColored then
            if not classList[classNameColored] then
                classList[classNameColored] = {}
            end
            --MasterLoot:LevelDebug(2, format("table.insert ii: <%s>", tostring(ii)))
            table.insert(classList[classNameColored], i , targetNameColored)
        end
    end
    return classList
end


function MasterLootFrame:CreateRandomRollDropDown()

    self.DropDown:AddLine(
            'text', L["全团随机roll"],
            'icon', "Interface\\Buttons\\UI-GroupLoot-Dice-Up",
            'iconWidth', 20,
            'iconHeight', 20,
            'func', function() self:GiveLootToCandidate("rr") end)

end


function MasterLootFrame:CreateSelfDropDown()
    self.DropDown:AddLine(
            'text', "|cFFBBBBBB"..L["分给自己"],
            'icon', "Interface\\GossipFrame\\VendorGossipIcon",
            'iconWidth', 20,
            'iconHeight', 20,
            'closeWhenClicked', true,
            'func', function()
                self:GiveLootToCandidate("self",UnitName("player")) end)
end

function MasterLootFrame:CreateClassListDropDown(classListTab)
    for k, v in classListTab do
        self.DropDown:AddLine(
                'text', k,
                'hasArrow', true,
                'value', v)
    end
end

function MasterLootFrame:CreateClassListPlayerDropDown(value)
    for k, v in value do
        local CandidateName = v
        local CandidateIndex = self.prefix..k
        self.DropDown:AddLine(
                'text', CandidateName,
                'closeWhenClicked', true,
                'tooltipFunc', GameTooltip.SetUnit,
                'tooltipArg1', GameTooltip ,
                'tooltipArg2',CandidateIndex ,
                'func', function()
                    self:GiveLootToCandidate("winner", CandidateName, CandidateIndex )
                end)
    end
end

function MasterLootFrame:GiveLootToCandidate(mode, CName, CandidateIndex )

    local indexForLoot
    if CandidateIndex then
        indexForLoot = self:GetMLID(UnitName(CandidateIndex))
    elseif CName then
        indexForLoot = self:GetMLID(CName)
    else
        local RName, RIndex = self:GetRandomMLID()
        indexForLoot = self:GetMLID(RName)
    end
    if not indexForLoot then
        MasterLoot:Print(CName .. L["没有拾取权"] )
        return
    end

    local nameForLoot = GetNumRaidMembers() > 0 and UnitName("raid"..indexForLoot) or UnitName("party"..indexForLoot)


    local channnel = GetNumRaidMembers() > 0 and "RAID" or "PARTY"
    if mode == "rr" then
        local message =  string.format("%s 全团随机roll 恭喜 %s 获胜", GetLootSlotLink(LootFrame.selectedSlot), nameForLoot)
        SendChatMessage(message, channnel)
    elseif mode == "winner" then
        local message =  string.format(" 恭喜 %s 获得 %s", nameForLoot, GetLootSlotLink(LootFrame.selectedSlot) )
        SendChatMessage(message, channnel)
    end

        GiveMasterLoot(LootFrame.selectedSlot, indexForLoot)
    end

function MasterLootFrame:GetRandomMLID()
    local max = GetNumRaidMembers() > 0 and 40 or 5
    local name, id
    while not name do
        id = math.random(1, max)
        name = GetMasterLootCandidate(id)
    end
    return name, id
end




function MasterLootFrame:GetMLID(name)
    if GetNumRaidMembers() > 0 then
        for i = 1, 40 do
            if GetMasterLootCandidate(i) == name then
                return i
            end
        end
    elseif GetNumPartyMembers() > 0 then
        for i = 1, MAX_PARTY_MEMBERS+1 do
            if GetMasterLootCandidate(i) == name then
                return i
            end
        end
    end
    return nil
end

function MasterLootFrame:GetRaidIndex(name)
    if GetNumRaidMembers() > 0 then
        for i = 1, 40 do
            if GetMasterLootCandidate(i) == name then
                return "raid"..i
            end
        end
    elseif GetNumPartyMembers() > 0 then
        for i = 1, MAX_PARTY_MEMBERS+1 do
            if GetMasterLootCandidate(i) == name then
                return "party"..i
            end
        end
    end
    return nil
end

function MasterLootFrame:GetClassNameWithColors(raidIndex)
    local targetName = UnitName(raidIndex)
    if not targetName then
        return
    end
    local className, classFilename = UnitClass(raidIndex)
    local c = RAID_CLASS_COLORS[classFilename]
    local classhexe = string.format("%2x%2x%2x", c.r*255, c.g*255, c.b*255)
    local classNameWithColors = string.format("|cff%s%s|r",  classhexe,  className)
    local targetNameWithColors = string.format("|cff%s%s|r",  classhexe, targetName)
    return classNameWithColors, targetNameWithColors
end

function MasterLootFrame:GetUnitNameWithColors(name)
    local raidIndex = self:GetRaidIndex(name)
    local className, classFilename = UnitClass(raidIndex)
    local c = RAID_CLASS_COLORS[classFilename]
    local classhexe = string.format("%2x%2x%2x", c.r*255, c.g*255, c.b*255)
    local nameWithColors = string.format("|cff%s%s|r",  classhexe, name)
    return nameWithColors
end
